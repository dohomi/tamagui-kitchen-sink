{"version":3,"file":"use-solito-image.js","sourceRoot":"","sources":["../../src/image/use-solito-image.ts"],"names":[],"mappings":"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","sourcesContent":["import { ImageStyle } from 'expo-image'\nimport { useMemo, useSyncExternalStore } from 'react'\nimport { ImageProps, Dimensions, StyleSheet } from 'react-native'\n\nimport { useSolitoImageContext } from './context'\nimport { defaultLoader } from './default-loader'\nimport {\n  generateImgAttrs,\n  getInt,\n  imageConfigDefault,\n  resolveSourceFromImgAttributes,\n} from './helpers'\nimport { SolitoImageProps } from './image.types'\nimport { ImageConfig } from './types'\n\nexport type UseSolitoImage = Pick<\n  ImageProps,\n  | Extract<keyof ImageProps, keyof SolitoImageProps>\n  | 'progressiveRenderingEnabled'\n  | 'source'\n  | 'accessible'\n  | 'onLayout'\n> & {\n  onLoadingComplete?: (info: { height: number; width: number }) => void\n  style: Array<ImageStyle | undefined>\n}\n\nexport function useSolitoImage({\n  src,\n  loader,\n  width,\n  height,\n  quality = 75,\n  crossOrigin,\n  referrerPolicy,\n  alt,\n  fill,\n  onLoadingComplete,\n  loading,\n  priority,\n  placeholder,\n  blurDataURL,\n  sizes,\n  style,\n  onLayout,\n  unoptimized,\n  ...props\n}: SolitoImageProps): UseSolitoImage {\n  const contextConfig = useSolitoImageContext()\n  const config = useMemo<ImageConfig>(() => {\n    const c = { ...imageConfigDefault, ...contextConfig }\n    const allSizes = [...c.deviceSizes, ...c.imageSizes].sort((a, b) => a - b)\n    const deviceSizes = c.deviceSizes.sort((a, b) => a - b)\n    return { ...c, allSizes, deviceSizes }\n  }, [contextConfig])\n\n  const headers: { [key in string]: string } = {}\n  if (crossOrigin === 'use-credentials') {\n    headers['Access-Control-Allow-Credentials'] = 'true'\n  }\n  if (referrerPolicy != null) {\n    headers['Referrer-Policy'] = referrerPolicy\n  }\n\n  const uri = useSyncExternalStore<string | undefined>(\n    (callback) => {\n      const subscription = Dimensions.addEventListener('change', callback)\n\n      return () => subscription?.remove()\n    },\n    () => {\n      const dimensions = Dimensions.get('window')\n\n      if (typeof src == 'string') {\n        const attrs = generateImgAttrs({\n          src,\n          config,\n          loader: ({ config: _, ...opts }) => {\n            if (loader) {\n              return loader(opts)\n            }\n            if (config.loader) {\n              return config.loader({\n                quality: Number(quality ?? 75),\n                src: opts.src,\n                width: opts.width,\n              })\n            }\n            return defaultLoader({ ...opts, config })\n          },\n          unoptimized: Boolean(unoptimized),\n          quality: getInt(quality || 75),\n          sizes,\n          width: getInt(width || 400),\n        })\n        const { uri } = resolveSourceFromImgAttributes({\n          ...attrs,\n          dimensions,\n        })\n\n        return uri\n      }\n      return undefined\n    }\n  )\n\n  const source = useMemo<ImageProps['source']>(() => {\n    const headers: { [key in string]: string } = {}\n    if (crossOrigin === 'use-credentials') {\n      headers['Access-Control-Allow-Credentials'] = 'true'\n    }\n    if (referrerPolicy != null) {\n      headers['Referrer-Policy'] = referrerPolicy\n    }\n    if (typeof uri == 'string') {\n      return {\n        uri,\n        height,\n        width,\n        headers,\n        cache: priority ? 'force-cache' : 'default',\n      }\n    }\n    return src as number\n  }, [uri, src, height, width, priority, referrerPolicy, crossOrigin])\n\n  return {\n    ...props,\n    progressiveRenderingEnabled: true,\n    onLoadingComplete,\n    source,\n    accessible: Boolean(alt),\n    onLayout,\n    style: [\n      fill\n        ? StyleSheet.absoluteFill\n        : {\n            height,\n            width,\n          },\n      style,\n    ] as any,\n\n    // adapter for older versions of RN\n    // https://github.com/facebook/react-native/blob/main/Libraries/Image/Image.android.js#L169-L194\n    accessibilityLabel: props['aria-label'] ?? alt,\n    accessibilityState: {\n      busy: booleanish(props['aria-busy']),\n      checked: booleanish(props['aria-checked']),\n      disabled: booleanish(props['aria-disabled']),\n      expanded: booleanish(props['aria-expanded']),\n      selected: booleanish(props['aria-selected']),\n    },\n  }\n}\n\nfunction booleanish<Value extends string | boolean>(value?: Value) {\n  // this should get upstreamed in RN\n  return (\n    value === 'true' ? true : value === 'false' ? false : value\n  ) as Exclude<Value, 'true' | 'false'>\n}\n"]}